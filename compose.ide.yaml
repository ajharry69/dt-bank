services:
  keycloak-database:
    image: postgres:17-alpine
    healthcheck:
      test: [ "CMD-SHELL", "psql test test --command=\"SELECT 1;\"" ]
      interval: 5s
      timeout: 15s
      retries: 5
    environment:
      POSTGRES_DB: "test"
      POSTGRES_USER: "test"
      POSTGRES_PASSWORD: "test"

  keycloak:
    image: ghcr.io/ajharry69/keycloak:26.2
    depends_on:
      keycloak-database:
        condition: service_healthy
    ports:
      - "8443:8443"
    environment:
      KC_DB_URL: "jdbc:postgresql://keycloak-database:5432/test"
      KC_DB_USERNAME: "test"
      KC_DB_PASSWORD: "test"
      KC_FEATURES: "preview,docker"
      KC_BOOTSTRAP_ADMIN_USERNAME: "admin"
      KC_BOOTSTRAP_ADMIN_PASSWORD: "admin"
    volumes:
      - ./gateway/src/test/resources/realm.json:/opt/keycloak/data/import/realm.json:ro
    command: start-dev --import-realm

  rabbitmq:
    image: "rabbitmq:4.1-alpine"
    environment:
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_DEFAULT_USER: guest
    ports:
      - "5672:5672"

  zipkin:
    image: "openzipkin/zipkin:3.5"
    ports:
      - "9411:9411"

  redis:
    image: redis:8.0-alpine
    ports:
      - "6379:6379"
